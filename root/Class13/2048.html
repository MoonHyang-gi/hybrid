<!DOCTYPE html>
<head>
    <title>2048</title>
</head>
<body>
    <style>
        #title{font-size: 40px; font-weight: bold;}
        #score{font-size: 20px; width: 300px; height: 30px;
            border: 2px solid black; }
        #cover{width: 650px;height: 650px; position:absolute; text-align: center;
            font-size: 40px; line-height: 700px; display: inline-block; top: 200px; 
            background-color: rgb(184, 171, 129, 0.50); margin-left: -325px; font-weight: bold;}
        #btn{width: 100px; height: 60px;}
        #app{width: 582px; height: 582px; background-color: beige;
            display: grid; grid-template-columns: 1fr 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr 1fr;
            grid-gap: 10px; padding: 10px; border-radius: 20px; font-size: 50px;
            position: relative;}
        .bg_block{background-color: burlywood; border-radius: 20px; text-align: center;}
        /* .box{position:absolute; top: 20px; left: 20px; width: 120px; height: 120px; background-color: brown; 
            text-align: center; border-radius: 20px; } */
    </style>
    <script src="https://unpkg.com/vue@3"></script>
    <center>
        <br><div id="title">2048</div><br>
        <div id="score">score: </div><br><br>

    <br><br><div id="app">
        <div class="bg_block" v-for = "index in bg_block_count">
        <!-- <div class="box" id="box1"></div>
        <div class="box" id="box2"></div>
        <div class="box" id="box3"></div>
        <div class="box" id="box4"></div>

        <div class="box" id="box5"></div>
        <div class="box" id="box6"></div>
        <div class="box" id="box7"></div>
        <div class="box" id="box8"></div>

        <div class="box" id="box9"></div>
        <div class="box" id="box10"></div>
        <div class="box" id="box11"></div>
        <div class="box" id="box12"></div>

        <div class="box" id="box13"></div>
        <div class="box" id="box14"></div>
        <div class="box" id="box15"></div>
        <div class="box" id="box16"></div> -->
    </div>
        <!-- <div class="bg_block" v-for = "index in bg_block_count">
             {{index}}</div> -->
        <!-- <div class="box"></div>
        <div class="box"></div>
        <div class="box"></div>
        <div class="box"></div>
        <div class="box"></div>
        <div class="box"></div>
        <div class="box"></div>
        <div class="box"></div>
        <div class="box"></div>
        <div class="box"></div>
        <div class="box"></div>
        <div class="box"></div>
        <div class="box"></div>
        <div class="box"></div>
        <div class="box"></div>
        <div class="box"></div> -->
    </div>
    <div id="cover">
    </div>
    <br><br><button id="btn" onclick="blockmap.init()">START</button>
    </center>
    <script>
        const {createApp} = Vue; 
        createApp({ 
            data(){
                return {
                    bg_block_count : 16,
                }
            },
            mounted(){
                console.log("app 마운트 성공!");
            }
        }).mount("#app");
    </script>

    <script>
// var box = document.getElementsByClassName("bg_block");
// var score = 0;
// var gameState = false;

// var boxID = Array(Array("box1", "box2", "box3", "box4"), Array("box5", "box6", "box7", "box8"),
//                 Array("box9", "box10", "box11", "box12"), Array("box13", "box14", "box15", "box16"));
// var board = Array(Array(0, 0, 0, 0), Array(0, 0, 0, 0), Array(0, 0, 0, 0), Array(0, 0, 0, 0));

var pool = new Array();
for(var i=0; i<pool.length; i++){
    pool.push(new Block(2));
}

class BlockMap{
    constructor(row,column){
        //this.Row = row;
        //this.Column = column;
        this.Map = Array.from(Array(row), () => Array(column).fill(0));
        this.div_app = document.getElementById("app");
        if(this.gameState==false){
            document.getElementById("cover").style.display = 'inline-block';
            this.init();
        }
    }

    addblock(x, y, block){
        block.setactive(true);
        block.setcoord(x, y);
        this.Map[x][y] = block;
        this.div_app.appendChild(block.Element);
    }
    // addrandomblock(block){
    //     block.setactive(true);

    //     //랜덤 블록 위치 생성

    //     block.setcoord(x, y);
    //     this.Map[x][y] = block;
    //     this.div_app.appendChild(block.div_element)
    // }

    removeblock(x, y){
        pool.push(this.Map[x][y]);
        this.Map[x][y] = null;
    }

    init(){
        this.gameState = true;
        this.score=0; 
        document.getElementById("cover").style.display = 'none';
        document.getElementById("score").innerHTML = "Score: " + this.score.toString();

        this.addblock(1,1, new Block(2));

        for(var i=0; i<4; i++){
            for(var j=0; j<4; j++){
                this.Map[i][j] = null;
            }
        }
        
        var rand = parseInt(Math.random() * 2);
        if(rand == 0){
            var rand = parseInt(Math.random()*16);
            var x = rand % 4;
            var y = parseInt(rand / 4);
            if(this.Map[x][y] == null){
                this.Map[x][y] = this.getNewNum();
            
        }
        }else{
            for(var i=0; i<2; i++){
                var rand = parseInt(Math.random()*16);
                var x = rand % 4;
                var y = parseInt(rand / 4);
                if(this.Map[x][y] == null){
                    this.Map[x][y] = (i+1)*2;
                }
            }
        }
    }

    // moveleft(){}
    // moveright(){}
    // moveup(){}
    // movedown(){}

    // draw(){
    //     // for(let i=0; i<this.Row; i++){
    //     //     for(let j=0; j<this.Column; j++){
    //     //         this.Map[x][y];
    //     //     }
    //     // }
    // }

    // 보드판 이동 방향에 따른 회전 컨트롤
    Compute(opt){ //보드판 회전 //이동연산
        switch(opt){
            case 0: this.move(); break; //up
            case 1: this.rotate(2); this.move(); this.rotate(2); break; //down
            case 2: this.rotate(1); this.move(); this.rotate(3); break; //left  
            case 3: this.rotate(3); this.move(); this.rotate(1); break; //right
        }
        //업데이트
    
        document.getElementById("score").innerHTML= ('Score: '+ this.score.toString());
        for(var i=0; i<4; i++){
            for(var j=0; j<4; j++){
                if(this.Map[i][j] == null) continue;
                this.Map[i][j].setcoord(j,i);
            }
        }
    }

    rotate(n){
        while(n--){
            var tempBoard 
            = Array.from(Array(4), ()=> Array(4).fill(null)); //여기
            for(var i=0;i<4;i++)
                for(var j=0;j<4;j++)
                    tempBoard[i][j]=this.Map[i][j];
            for(var i=0;i<4;i++)
                for(var j=0;j<4;j++)
                    this.Map[j][3-i]=tempBoard[i][j];

        }
    }

    // 보드판 이동
    move(){
        var isMoved=false;
        var isPlused 
        = Array(Array(0,0,0,0),Array(0,0,0,0),Array(0,0,0,0),Array(0,0,0,0));
        for(var i=1;i<4;i++){
            for(var j=0;j<4;j++){
                if(this.Map[i][j]==null) continue;
                var tempY = i-1;
                while(tempY>0 && this.Map[tempY][j]==null) tempY--;
                if(this.Map[tempY][j]==null){
                    this.Map[tempY][j]=this.Map[i][j];
                    this.Map[i][j]=0;
                    isMoved=true;
                }
                else if(this.Map[tempY][j]!=this.Map[i][j]){
                    if(tempY+1==i) continue;
                    this.Map[tempY+1][j]=this.Map[i][j];
                    this.Map[i][j]=null;
                    isMoved=true;
                }
                else{
                    if(isPlused[tempY][j]==null){  //여기
                        this.Map[tempY][j]*=2; 
                        this.Mapd[i][j]=null;
                        isPlused[tempY][j]=1;
                        isMoved=true;
                    }
                    else{
                        this.Map[tempY+1][j]=this.Map[i][j];
                        this.Map[i][j]=null;
                        isMoved=true;
                    }
                }
            }
        }
        if(isMoved){
            this.score = this.score++;
            this.generate();
            
        }else this.check();
    }

    //숫자 생성
    generate(){
        var zeroNum = 0;
        for(var i=0; i<4; i++){
            for(var j=0; j<4; j++){
                if(this.Map[i][j] == null)
                {
                    zeroNum++;
                }
            }
        }
        while(true){
            for(var i=0; i<4; i++){
                for(var j=0; j<4; j++){
                    if(this.Map[i][j]==null){
                        var rand = parseInt(Math.random() * zeroNum);
                        if(rand == 0){
                            this.Map[i][j] = getNewNum(); //여기
                            return;
                        }
                    }
                }
            }
        }
    }

    //숫자 생성 2, 4 확률
    getNewNum(){
        var rand = parseInt(Math.random() * 10);
        if(rand == 0){
            return 4;
        }
        else
        return 2;
    }

    check(){
        for(var i=0;i<4;i++){
            var colCheck = this.Map[i][0];
            if(colCheck==null) return;
            for(var j=1;j<4;j++){
                if(this.Map[i][j]==colCheck || this.Map[i][j]==null) return;
                else colCheck = this.Map[i][j];
            }
        }
        for(var i=0;i<4;i++){
            var rowCheck = this.Map[0][i];
            if(rowCheck==null) return;
            for(var j=1;j<4;j++){
                if(this.Map[j][i]==rowCheck || this.Map[j][i]==null) return;
                else rowCheck = this.Map[j][i];
            }
        }
        this.gameOver();
    }


    gameOver(){
        this.gameState=false;
        document.getElementById("cover").style.display = 'inline-block';
        document.getElementById("cover").innerHTML = ("Game Over");
    }
}

var blockmap = new BlockMap(4, 4);

class Block{
    constructor(value){
        this.Value = value;
        this.Active = false;
        this.XPos = 20;
        this.YPos = 20;
        this.Element = document.createElement("div");
        this.Element.setAttribute("class", "bg_block");
        //this.div_element.appendChild(document.createTextNode("2"));
        this.Element.append(this.Value);
    }

    changevalue(value){
        this.Value = value;
        this.Element.innerHTML = this.Value;
    }
    setactive(isActivated){
        this.Element.style.display = "block";
        this.Active = isActivated;
    }
    setcoord(x, y){
        this.XPos += 150 * x;
        this.YPos += 150 * y;
        // this.div_element.style.left = this.XPos;
        // this.div_element.style.right = this.YPos;
    }
    removeblock(){
        this.Element.style.display = "none";
        this.Active = false;
        this.XPos = 20;
        this.YPos = 20;
        this.changevalue(2);
    }
}

window.onkeydown = keylog;

// function gameStart(){
//     blockmap.addblock(Math.floor(Math.random() * 4), Math.floor(Math.random() * 4), new Block(2));
// }

// //키보드 입력
// document.onkeyup = keyUpEventHandler; 
// function keyUpEventHandler(e){
//     switch(e.keyCode){
//         case 38: moveDir(0); break; //up
//         case 40: moveDir(1); break; //down
//         case 37: moveDir(2); break; //left
//         case 39: moveDir(3); break; //right
//     }
// }

    function keyArrowRight(){
        //box[0].style.left  = '463px';
        let blocks = document.getElementsByClassName("box");
        for(let i=0; i<blocks.length; i++){
            blocks[i].style.left += 463;
        }
    }

    function keyArrowLeft(){
        //box[0].style.left  = '20px';
        let blocks = document.getElementsByClassName("box");
        for(let i=0; i<blocks.length; i++){
            blocks[i].style.left -= 20;
        }
    }

    function keyArrowUp(){
        //box[0].style.top  = '20px';
        let blocks = document.getElementsByClassName("box");
        for(let i=0; i<blocks.length; i++){
            blocks[i].style.left -= 463;
        }
    }

    function keyArrowDown(){
        //box[0].style.top  = '463px';
        let blocks = document.getElementsByClassName("box");
        for(let i=0; i<blocks.length; i++){
            blocks[i].style.left += 463;
        }     
    }

    // function keyEnter(){
    //     blockmap.addblock(1,1, new Block(2));
    // }

    function keylog(e){
        console.log(e.key);
        switch(e.key){
            case 'ArrowRight':
                keyArrowRight();
                break;
            case 'ArrowLeft':
                keyArrowLeft();
                break;
            case 'ArrowUp':
                keyArrowUp();
                break;
            case 'ArrowDown':
                keyArrowDown();
                break;
            default:
                break;
        }
    }

    </script>
</body>
</html>